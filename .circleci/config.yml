version: 2.1
context: gcp_context
jobs:
  build_and_push:
    docker: 
      - image: google/cloud-sdk:latest 
    steps:
      - checkout

      # Build the Docker image
      - setup_remote_docker:
          version: 20.10.7
      - run:
          name: Set authorization code environment variable
          command: |
            export GCP_AUTH_CODE=4/0AZEOvhUFTb1DQIKJ3hoTTqCUpJLfHcjNVXFw8gtpAd3J-mucjQSi9onoNZr8i9SBOwWLDQ
      - run:
          name: Build Docker image
          command: |
            docker build -t ohif-viewer:${CIRCLE_SHA1} .
            gcloud auth login --no-launch-browser --impersonate-service-account=$GCLOUD_SERVICE_ACCOUNT --access-token=$GCP_AUTH_CODE
            docker tag ohifviewer:${CIRCLE_SHA1} gcr.io/prod-healthsafe/ohif-viewer:${CIRCLE_SHA1}
            docker push gcr.io/prod-healthsafe/ohif-viewer:${CIRCLE_SHA1}

  deploy_to_gke:
    docker:
      - image: google/cloud-sdk:latest

    steps:
      - checkout

      # Configure Google Cloud SDK
      - run:
          name: Configure Google Cloud SDK
          command: |
            echo $SERVICE_ACCOUNT_KEY | base64 --decode --ignore-garbage > ${HOME}/gcp-service-key.json
            gcloud auth activate-service-account --key-file=${HOME}/gcp-service-key.json
            gcloud container clusters get-credentials your-cluster-name --zone your-cluster-zone --project your-gcp-project

      # Deploy to GKE
      - run:
          name: Deploy to GKE
          command: |
            kubectl set image deployment/your-deployment-name your-container-name=gcr.io/your-gcp-project/your-image-name:${CIRCLE_SHA1}

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_and_push
      - deploy_to_gke:
          requires:
            - build_and_push